require("source-map-support").install(),function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},s.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s.w={},s(s.s=24)}([function(e,t,s){e.exports.v1_0_0={user:s(9),utils:s(1)}},function(e,t,s){(function(e){var n=s(18),r=s(17),o=s(16),a=s(2);t.encrypt=function(e){try{return{value:e.map((e,t)=>{let s=n.createCipher(process.env.ALGORITHM,process.env.KEY);return s.update(Buffer.from(e),"utf8","hex")+s.final("hex")}),error:null}}catch(e){return{value:null,error:e}}},t.decrypt=function(e){let t=n.createDecipher(process.env.ALGORITHM,process.env.KEY);return t.update(e,"hex","utf8")+t.final("utf8")},t.createToken=function(t,s){return new Promise((n,a)=>{let i=r.readFileSync(e+"/../../keys/key.pem").toString();void 0===i&&a({code:500,msg:"error on load private key"});let c={id:t.id},u={expiresIn:"8h",algorithm:"RS256",subject:s};o.sign(c,i,u,function(e,t){e&&a({code:500,msg:e.message}),n(t)})})},t.validateToken=function(t,s){return new Promise((n,i)=>{let c=r.readFileSync(e+"/../../keys/cert.pem").toString();void 0===c&&i("error on load public key");let u={algorithms:["RS256"],subject:s};o.verify(t,c,u,function(e,t){e&&i({code:500,msg:e.message}),a.User.findById(t.id).then(e=>n(e),e=>i({code:500,msg:e.message}))})})},t.deleteAll=function(){return new Promise((e,t)=>{a.sequelize.query("SET FOREIGN_KEY_CHECKS = 0",{raw:!0}).then(()=>{a.User.truncate().then(()=>{a.Record.remove({},()=>{a.sequelize.query("SET FOREIGN_KEY_CHECKS = 1",{raw:!0}).then(()=>e(),e=>t(e))})},e=>t(e))},e=>t(e))})},t.testSeed=function(){return new Promise((e,t)=>{s(3).testSeed(a).then(()=>e(),e=>t(e))})}}).call(this,"src/business/v1.0.0")},function(e,t,s){var n=s(4),r=s(21),o="",a="";o="mongodb://localhost:27017/myproject",a="mysql://api:123qwe@localhost:3306/node";const i={$eq:r.Op.eq,$ne:r.Op.ne,$gte:r.Op.gte,$gt:r.Op.gt,$lte:r.Op.lte,$lt:r.Op.lt,$not:r.Op.not,$in:r.Op.in,$notIn:r.Op.notIn,$is:r.Op.is,$like:r.Op.like,$notLike:r.Op.notLike,$iLike:r.Op.iLike,$notILike:r.Op.notILike,$regexp:r.Op.regexp,$notRegexp:r.Op.notRegexp,$iRegexp:r.Op.iRegexp,$notIRegexp:r.Op.notIRegexp,$between:r.Op.between,$notBetween:r.Op.notBetween,$overlap:r.Op.overlap,$contains:r.Op.contains,$contained:r.Op.contained,$adjacent:r.Op.adjacent,$strictLeft:r.Op.strictLeft,$strictRight:r.Op.strictRight,$noExtendRight:r.Op.noExtendRight,$noExtendLeft:r.Op.noExtendLeft,$and:r.Op.and,$or:r.Op.or,$any:r.Op.any,$all:r.Op.all,$values:r.Op.values,$col:r.Op.col};n.connect(o);var c=new r(a,{operatorsAliases:i,logging:!1});const u={User:s(20)(c,r),Record:s(19)};Object.keys(u).forEach(e=>{u[e].associate&&u[e].associate(u)}),u.sequelize=c,u.mongoose=n.connection,e.exports=u},function(e,t,s){var n=s(1);e.exports.seed=(e=>new Promise((t,s)=>{e.User.count({where:{admin:!0}}).then(r=>{if(r<1){let r=n.encrypt(["admin@a.aa","user2@a.aa","123qweASD"]);r.error?s(r.error):e.User.bulkCreate([{email:r.value[0],admin:!0,password:r.value[2]},{email:r.value[1],password:r.value[2]}]).then(n=>e.Record.insertMany([{value:"20",datetime:"2018-03-08T09:43:40.000Z"},{value:"22",datetime:"2018-03-08T09:47:28.000Z"},{value:"19",datetime:"2018-03-08T09:53:47.000Z"}],(e,n)=>{e&&s(e),t()}),e=>s(e))}else t()},e=>s(e))})),e.exports.testSeed=(e=>new Promise((t,s)=>{let r=n.encrypt(["admin@a.aa","123qweASD"]);r.error?s(r.error):e.User.create({email:r.value[0],admin:!0,password:r.value[1]}).then(()=>t(),e=>s(e))}))},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("body-parser")},function(e,t,s){e.exports=(e=>{var t=s(5),n=s(0).v1_0_0.utils;e.use(t.urlencoded({extended:!0})),e.use(t.json()),e.use((e,t,s)=>{if(t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization, Accept-Version"),t.header("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),t.header("Access-Control-Allow-Credentials",!0),"OPTIONS"===e.method)return t.send(200);e.headers.authorization?n.validateToken(e.headers.authorization,e.connection.remoteAddress).then(t=>{e.client=t||null,s()},t=>{e.client=null,s()}):(e.client=null,s())})})},function(e,t){e.exports=require("express-routes-versioning")},function(e,t,s){var n=s(0).v1_0_0;t.register=function(e,t){n.user.register(e.body.email,e.body.password).then(s=>{n.utils.createToken(s,e.connection.remoteAddress).then(e=>t.status(200).json({token:e,user:s.id}),e=>t.status(e.code).send(e.msg))},e=>t.status(500).send(e.msg))},t.login=function(e,t){n.user.login(e.body.email,e.body.password).then(s=>{n.utils.createToken(s,e.connection.remoteAddress).then(e=>t.status(200).json({token:e,user:s.id}),e=>t.status(e.code).send(e.msg))},e=>t.status(e.code).send(e.msg))},t.changePassword=function(e,t){e.client&&"User"===e.client.constructor.name?n.user.changePassword(e.client.id,e.body.old_password,e.body.new_password).then(()=>t.status(200).json({result:!0}),e=>t.status(e.code).send(e.msg)):t.status(401).send("Unauthorized")}},function(e,t,s){var n=s(2),r=s(1);t.register=function(e,t){return new Promise((s,o)=>{if(/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)[A-Za-z\d$@$!%*#?&-.]{8,}$/.test(t))if(/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/.test(e)){let a=r.encrypt([e,t]);a.error?o({code:500,msg:a.error.message}):n.User.create({email:a.value[0],password:a.value[1]}).then(e=>s(e),e=>o({code:500,msg:e.message}))}else o({code:500,msg:"invalid email"});else o({code:500,msg:"invalid password, must have at least one uppercase letter, one lowercase, one digit and a minimum 8 characters"})})},t.login=function(e,t){return new Promise((s,o)=>{let a=r.encrypt([e,t]);a.error?o({code:500,msg:error.message}):n.User.findOne({where:{email:a.value[0],password:a.value[1]}}).then(e=>{e?s(e):o({code:500,msg:"email and password don't match"})},e=>o({code:500,msg:a.error.message}))})},t.changePassword=function(e,t,s){return new Promise((o,a)=>{if(/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)[A-Za-z\d$@$!%*#?&-.]{8,}$/.test(s)){let i=r.encrypt([t,s]);i.error?a({code:500,msg:i.error.message}):n.User.findOne({where:{id:e,password:i.value[0]}}).then(e=>{e?e.update({password:i.value[1]}).then(()=>o(),e=>a({code:500,msg:e.message})):a({code:500,msg:"old password don't match"})},e=>a({code:500,msg:e.message}))}else a({code:500,msg:"invalid password, must have at least one uppercase letter, one lowercase, one digit and a minimum 8 characters"})})},t.findByEmail=function(e,t){return new Promise((t,s)=>{let o=r.encrypt([e]);o.error?s({code:500,msg:error.message}):n.User.findOne({where:{email:o.value[0]}}).then(e=>{e?t(e):s({code:500,msg:"user not registered"})},e=>s({code:500,msg:o.error.message}))})}},function(e,t,s){var n=s(0).v1_0_0;t.destroyAll=function(e,t){n.utils.deleteAll().then(()=>t.status(200).json({success:!0}),e=>t.status(500).send(e.msg))},t.testDb=function(e,t){n.utils.deleteAll().then(()=>n.utils.testSeed().then(t.status(200).json({success:!0}),e=>t.status(500).send(e.msg)),e=>t.status(500).send(e.msg))}},function(e,t,s){e.exports.v1_0_0={manage:s(10),user:s(8)}},function(e,t,s){e.exports=(e=>{var t=s(11),n=s(7)();e.post("/register",n({"1.0.0":t.v1_0_0.user.register,"2.0.0":(e,t)=>t.json({error:"invalid version"})})).post("/login",n({"1.0.0":t.v1_0_0.user.login})).post("/chpass",n({"1.0.0":t.v1_0_0.user.changePassword})).get("/destroy",n({"1.0.0":t.v1_0_0.manage.destroyAll})).get("/testdb",n({"1.0.0":t.v1_0_0.manage.testDb})),e.all("*",(e,t)=>{t.status(404).json({message:"Route could not be found"})})})},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("crypto")},function(e,t,s){var n=s(4),r=new n.Schema({value:{type:Number,required:!0},datetime:{type:Date,default:Date.now()}},{versionKey:!1});e.exports=n.model("Record",r)},function(e,t,s){"use strict";e.exports=((e,t)=>{var s=e.define("User",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},email:{type:t.STRING,allowNull:!1,unique:{args:!0,msg:"email already registered"}},password:{type:t.STRING,allowNull:!1},admin:{type:t.BOOLEAN,defaultValue:!1}},{scopes:{profile:{attributes:{exclude:["password"]}}},underscored:!0});return s.associate=function(e){},s})},function(e,t){e.exports=require("sequelize")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("cluster")},function(e,t,s){(function(e){var t=s(23);if(s(22).config(),t.isMaster){var n=s(2);n.sequelize.sync().then(()=>{s(3).seed(n).then(()=>{console.log("[32m%s[0m.","(PLAIN) Connection established with MongoDB and MySQL");var e=s(15).cpus().length;console.log("Master cluster setting up "+e+" workers...");for(var n=0;n<e;n++)t.fork();t.on("exit",function(e,s,n){console.log("Worker "+e.process.pid+" died with code: "+s+", and signal: "+n+"-> Starting a new worker"),t.fork()})},e=>{console.log("Unable to seed Databases.",e.message),process.exit(1)})},e=>{console.log("Unable to connect to Databases.",e),process.exit(1)})}else{var r=s(14),o=s(13),a=s(12),i=s(6),c=r();c.use("/",r.static(o.resolve(e,"public"))),c.use("/docs",r.static(o.resolve(e,"docs"))),i(c),a(c);var u=process.env.PORT||8080;c.listen(u,()=>{console.log("[32m%s %d[0m.","(PLAIN) Server http listening on port",u)})}}).call(this,"")}]);
//# sourceMappingURL=bundle.js.map